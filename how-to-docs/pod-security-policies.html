<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Pod Security Policies - Application Container Platform</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Pod Security Policies";
    var mkdocs_page_input_path = "how-to-docs/pod-security-policies.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="icon icon-home"> Application Container Platform</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../index.html">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../services.html">Services</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../releases-notes/index.html">Release Notes</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="index.html">How To's</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../developer-docs/index.html">Developer Getting Started Guide</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../newuser.html">New User Guide</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../rbac.html">RBAC Guide</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../external-addresses.html">ACP External IPs</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../service-lifecycle.html">Service Lifecycle</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Application Container Platform</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
    
      
    
    <li>Pod Security Policies</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="pod-security-policies">Pod Security Policies<a class="headerlink" href="#pod-security-policies" title="Permanent link">#</a></h1>
<p>By default all user deployments will inherit a default PodSecurityPolicy applied in the Kubernetes Clusters, which define a set of conditions that a pod must be configured with in order to run successfully.</p>
<p>The specification for the default policy is as follows:</p>
<pre><code class="yaml">apiVersion: extensions/v1beta1
kind: PodSecurityPolicy
metadata:
  name: default
spec:
  privileged: false
  fsGroup:
    rule: RunAsAny
  hostPID: false
  hostIPC: false
  hostNetwork: false
  runAsUser:
    rule: MustRunAsNonRoot
  seLinux:
    rule: RunAsAny
  supplementalGroups:
    rule: RunAsAny
  volumes:
  - configMap
  - downwardAPI
  - emptyDir
  - gitRepo
  - persistentVolumeClaim
  - projected
  - secret
</code></pre>

<h2 id="runasuser"><code>runAsUser</code><a class="headerlink" href="#runasuser" title="Permanent link">#</a></h2>
<p>This condition requires that the pod specification deploys an image with a non-root user. The user defined in the specification (image spec OR pod spec) must be numeric, so that Kubernetes will be able to verify that it is a non-root user. If this is not done, you may receive any of the following errors in your event log and your pod will be prevented from starting up successfully:
- <code>container's runAsUser breaks non-root policy</code>
- <code>container has runAsNonRoot and image will run as root</code>
- <code>container has runAsNonRoot and image has non-numeric user &lt;username&gt;, cannot verify user is non-root</code></p>
<blockquote>
<p><strong>Note:</strong> You can view all recent events in your namespace by running the following command: <code>kubectl -n my-namespace get events --sort-by=.metadata.creationTimestamp</code>.</p>
</blockquote>
<p>To update your deployment accordingly for the above condition, there are multiple ways to achieve this:</p>
<h3 id="dockerfile">Dockerfile<a class="headerlink" href="#dockerfile" title="Permanent link">#</a></h3>
<p>Within the <code>Dockerfile</code> for the image you are attempting to run, ensure the <code>USER</code> specified references the User ID rather than the username itself. For example:</p>
<pre><code>FROM quay.io/gambol99/keycloak-proxy:v2.1.1
LABEL maintainer=&quot;rohith.jayawardene@digital.homeoffice.gov.uk&quot;

RUN adduser -D -u 1000 keycloak

USER 1000
</code></pre>

<blockquote>
<p><strong>Note:</strong> The following common images have been updated to reference the UID within their respective Dockerfiles. If you use any of these images, updating your deployments to use these versions (or any newer versions) will meet the <code>MustRunAsNonRoot</code> requirement for this particular container:</p>
</blockquote>
<pre><code>quay.io/ukhomeofficedigital/cfssl-sidekick:v0.0.6
quay.io/ukhomeofficedigital/elasticsearch:v1.5.3
quay.io/ukhomeofficedigital/jira:v7.9.1
quay.io/ukhomeofficedigital/keycloak:v3.4.3-2
quay.io/ukhomeofficedigital/kibana:v0.4.4
quay.io/ukhomeofficedigital/go-keycloak-proxy:v2.1.1
quay.io/ukhomeofficedigital/nginx-proxy:v3.2.9
quay.io/ukhomeofficedigital/nginx-proxy-govuk:v3.2.9.0
quay.io/ukhomeofficedigital/redis:v0.1.2
quay.io/ukhomeofficedigital/squidproxy:v0.0.5
</code></pre>

<h3 id="deployment-spec">Deployment Spec<a class="headerlink" href="#deployment-spec" title="Permanent link">#</a></h3>
<p>In the <code>securityContext</code> section of your deployment spec, the <code>runAsUser</code> field can be used to set a UID that the image should be run as.</p>
<p>An example spec would include:</p>
<pre><code class="yaml">    spec:
      securityContext:
        fsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      containers:
      - name: &quot;{{ .IMAGE_NAME }}&quot;
        image: &quot;{{ .IMAGE }}:{{ .VERSION }}&quot;
        ...
</code></pre>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
