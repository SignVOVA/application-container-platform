<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Chisel - Application Container Platform</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Chisel";
    var mkdocs_page_input_path = "how-to-docs/chisel.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="icon icon-home"> Application Container Platform</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../index.html">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../services.html">Services</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../releases-notes/index.html">Release Notes</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="index.html">How To's</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../developer-docs/index.html">Developer Getting Started Guide</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../newuser.html">New User Guide</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../rbac.html">RBAC Guide</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../external-addresses.html">ACP External IPs</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../service-lifecycle.html">Service Lifecycle</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Application Container Platform</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
    
      
    
    <li>Chisel</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="chisel">Chisel<a class="headerlink" href="#chisel" title="Permanent link">#</a></h1>
<blockquote>
<p><em>The Problem</em>: we want to provide services running in ACP access to the third party services as well as the ability to have user-based access controls. At present network access in ACP is provided via Calico, but this becomes redundant when the traffic egresses the cluster. Simply peering networks together either through VPC peering or VPN connections doesn't provide the controls we want. We could rely on user-authentication on third-party service but not all services are authenticated (take POISE) and beyond that peering networks provides no means of auditing traffic that is traversing the bridged networks.</p>
</blockquote>
<p>One pattern we are exploring is the use of a proxy cluster with an authenticated side-kick to route traffic and provide end-to-end encryption. Both ACP Notprod and Prod are peered to an respective proxy cluster that is running a <a href="https://github.com/jpillora/chisel">Chisel</a> server. Below is rough idea of how the chisel service works.</p>
<p><img alt="alt text" src="https://github.com/UKHomeOffice/application-container-platform/blob/master/how-to-docs/pics/chisel.png" title="Chisel" /></p>
<p>The workflow for this is as follows, note the following example is assuming we have peered with a network in the proxy cluster which is exposing x services.</p>
<ul>
<li>A request via BAU the provisioning of a service on the Chisel server.</li>
<li>Once done user is provided credentials for service.</li>
<li>You add into your deployment a chisel container running in client mode and add the configuration as described to route the traffic. In regard to DNS and hostnames, kubernetes pods permit the user to add host entries into the container DNS, enabling you to override.</li>
<li>The traffic is picked up, encrypted over an ssh tunnel and pushed to the Chisel server where the user credentials are evaluated. Assuming everything is ok the traffic is then proxied on to destination.</li>
</ul>
<h3 id="a-working-example">A Working Example<a class="headerlink" href="#a-working-example" title="Permanent link">#</a></h3>
<p>We have a two services called <code>example-api.internal.homeoffice.gov.uk</code> and <code>another-service.example.com</code> and we wish to consume the API from the pods. Lets assume the service has already been provisioned on the Chisel server and we have the credentials at hand.</p>
<pre><code class="YAML">kind: Deployment
metadata:
  name: consumer
spec:
  replicas: 1
  template:
    metadata:
      labels:
        name: consumer
    spec:
      hostAliases:
      - hostnames:
        - another-service.example.com
        - example-api.internal.homeoffice.gov.uk
        ip: 127.0.0.1
      securityContext:
        fsGroup: 1000
      volumes:
      - name: bundle
        configMap:
          name: bundle
      containers:
      - name: consumer
        image: quay.io/ukhomeofficedigital/someimage:someversion
      - name: chisel
        image: quay.io/ukhomeofficedigital/chisel:latest
        securityContext:
          runAsNonRoot: true
        env:
        # essentially user:password
        - name: AUTH
          valueFrom:
            secretKeyRef:
              name: chisel
              key: chisel.auth
        # this optional BUT recommended this is fingerprint for the SSH service
        - name: CHISEL_KEY
          valueFrom:
            secretKeyRef:
              name: chisel
              key: chisel.key
        args:
        - client
        - -v
        # this the chisel endpoint service hostname
        - gateway-internal.px.notprod.acp.homeoffice.gov.uk:443
        # this is saying listen on port 10443 and route all traffic to another-service.example.com:443 endpoint
        - 127.0.0.1:10443:another-service.example.com:443
        - 127.0.0.1:10444:example-api.internal.homeoffice.gov.uk:443
        volumeMounts:
        - name: bundle
          mountPath: /etc/ssl/certs
          readOnly: true
</code></pre>

<p>The above embeds the sidekick into the Pod and requests the client to listen on localhost:10443 and 10444 to redirect traffic via the Chisel service. The one annoying point here is the port requirements, placing things on different ports, but unfortunately this is required. You should be able to call the service via <code>curl https://another-service.example.com:10443</code> at this point.</p>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
