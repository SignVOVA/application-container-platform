<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>TLS Passthrough - Application Container Platform</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "TLS Passthrough";
    var mkdocs_page_input_path = "how-to-docs/ssl-passthrough.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="icon icon-home"> Application Container Platform</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../index.html">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../services.html">Services</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../releases-notes/index.html">Release Notes</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="index.html">How To's</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../developer-docs/index.html">Developer Getting Started Guide</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../newuser.html">New User Guide</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../rbac.html">RBAC Guide</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../external-addresses.html">ACP External IPs</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../service-lifecycle.html">Service Lifecycle</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Application Container Platform</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
    
      
    
    <li>TLS Passthrough</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="tls-passthrough">TLS Passthrough<a class="headerlink" href="#tls-passthrough" title="Permanent link">#</a></h1>
<p>There are occasions when you don't want the TLS to be terminated on the ingress and prefer to terminate in the pod instead. Note, by terminating in the pod the ingress will no longer be able to perform any L7 actions, so all of the feature set is lost (effectively it's become a TLS proxy using SNI to route the traffic)</p>
<h4><strong>Example steps</strong></h4>
<p>First create a kubernetes secret containing the certificate you wish to use.</p>
<pre><code class="shell">$ kubectl create secret tls tls --cert=cert.pem --key=cert-key.pem
</code></pre>

<p>Create the deployment and service.</p>
<pre><code class="YAML">---
apiVersion: v1
kind: Service
metadata:
  labels:
    name: tls-passthrough
  name: tls-passthrough
spec:
  type: ClusterIP
  ports:
  - name: https
    port: 443
    protocol: TCP
    targetPort: 10443
  selector:
    name: tls-passthrough
---
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: tls-passthrough
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  template:
    metadata:
      labels:
        name: tls-passthrough
    spec:
      volumes:
      - name: certs
        secret:
          secretName: tls
      containers:
      - name: proxy
        image: quay.io/ukhomeofficedigital/nginx-proxy:v3.2.0
        ports:
        - name: https
          containerPort: 10443
          protocol: TCP
        env:
        - name: PROXY_SERVICE_HOST
          value: &quot;127.0.0.1&quot;
        - name: PROXY_SERVICE_PORT
          value: &quot;8080&quot;
        - name: SERVER_CERT
          value: /certs/tls.crt
        - name: SERVER_KEY
          value: /certs/tls.key
        - name: ENABLE_UUID_PARAM
          value: &quot;FALSE&quot;
        - name: NAXSI_USE_DEFAULT_RULES
          value: &quot;FALSE&quot;
        - name: PORT_IN_HOST_HEADER
          value: &quot;FALSE&quot;
        volumeMounts:
        - name: certs
          mountPath: /certs
          readOnly: true
      - name: fake-application
        image: kennethreitz/httpbin:latest
</code></pre>

<p>Push out the ingress resource indicating you want ssl-passthrough enabled.</p>
<pre><code class="YAML">---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    ingress.kubernetes.io/ssl-passthrough: &quot;true&quot;
    kubernetes.io/ingress.class: &quot;nginx-external&quot;
  name: tls-passthrough
spec:
  rules:
  - host: tls-passthrough.notprod.homeoffice.gov.uk
    http:
      paths:
      - backend:
          serviceName: tls-passthrough
          servicePort: 443
        path: /
</code></pre>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
